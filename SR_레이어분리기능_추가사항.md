# SR 리습 레이어 분리 기능 추가 사항

## 🔍 개요
기존 SR 리습에 SRQ 리습의 레이어 분리 기능을 통합하여, 뷰포트 내부 측정 모드에서 레이어를 분리한 후 측정할 수 있는 기능을 추가했습니다.

## 🚀 주요 추가 기능

### 1. 레이어 분리 기능 (뷰포트 측정 모드 전용)
- **활성화 시점**: 뷰포트 내부 측정 모드에서 뷰포트 활성화 후
- **사용자 선택**: "레이어 분리를 하시겠습니까?" 프롬프트로 선택 가능
- **작동 방식**: 
  - 표시할 레이어의 객체들을 선택
  - 선택된 객체들의 레이어만 표시하고 나머지 레이어는 숨김
  - 페이퍼스페이스 레이어는 그대로 유지

### 2. 레이어 상태 관리
- **자동 저장**: 레이어 분리 전 원래 상태 자동 저장
- **자동 복원**: 작업 완료 후 또는 오류 발생 시 자동 복원
- **전역 변수**: 
  - `g_original_vp_layer_states`: 원래 레이어 상태 저장
  - `g_layer_separation_active`: 레이어 분리 활성 상태 플래그

## 🔧 추가된 함수들

### 레이어 분리 관련 함수
1. **`perform-layer-separation`**: 레이어 분리 실행
2. **`restore-layer-states`**: 레이어 상태 복원
3. **`remove-duplicates`**: 중복 레이어 제거
4. **`layers-to-string`**: 레이어 목록을 문자열로 변환

### MVO 뷰포트 지원 함수 (SRQ에서 가져옴)
5. **`find-viewport-from-polyline`**: 폴리선에서 뷰포트 찾기
6. **`is-mvo-polyline`**: MVO 폴리선 여부 확인

## 🛡️ 오류 처리 강화

### 오류 핸들러 개선
- 레이어 분리 상태에서 오류 발생 시 자동으로 레이어 상태 복원
- ESC 키나 예외 상황에서도 안전하게 레이어 상태 복원

### 프로그램 종료 시 정리
- 프로그램 정상 종료 시 레이어 상태 최종 확인 및 복원
- 메모리 누수 방지를 위한 전역 변수 정리

## 📝 사용법

### 뷰포트 내부 측정 모드에서 레이어 분리 사용하기

1. **SR 명령 실행**
   ```
   Command: SR
   ```

2. **뷰포트 내부 모드 선택**
   ```
   작업을 선택하세요 [뷰포트 내부(V)/배치 공간(P)] <뷰포트 내부>: V
   ```

3. **뷰포트 선택**
   ```
   활성화할 뷰포트 또는 폴리선 경계를 선택하세요:
   ```

4. **레이어 분리 여부 선택** (새로 추가됨)
   ```
   레이어 분리를 하시겠습니까? [예(Y)/아니오(N)] <아니오>: Y
   ```

5. **레이어 분리 객체 선택** (Y 선택 시)
   ```
   === 레이어 분리 모드 ===
   표시할 레이어의 객체들을 선택하세요 (Enter로 완료):
   ```

6. **측정 진행**
   - 선택한 레이어의 객체들만 표시된 상태에서 측정 진행
   - 기존 SR 기능은 모두 동일하게 작동

## 🔄 워크플로우

```
SR 실행 → 뷰포트 모드 선택 → 뷰포트 선택 → 뷰포트 활성화 
    ↓
레이어 분리 여부 선택 (첫 실행 시에만)
    ↓
[예 선택 시] 레이어 분리 객체 선택 → 레이어 분리 실행
    ↓
측정 진행 (기존 SR 기능과 동일)
    ↓
작업 완료 → 레이어 상태 자동 복원
```

## 🎯 주요 특징

### 1. 첫 실행 시에만 레이어 분리 선택
- 뷰포트에서 첫 번째 측정 시에만 레이어 분리 여부를 물어봄
- 동일 뷰포트에서 반복 측정 시에는 레이어 분리 상태 유지

### 2. 자동 상태 관리
- 레이어 분리 후 측정 완료 시 자동으로 원래 상태 복원
- 오류 발생 시에도 안전하게 원래 상태 복원

### 3. 기존 기능 보존
- 기존 SR 리습의 모든 기능 완전 보존
- 모형공간/배치공간 측정 모드는 변경 없음

## ⚠️ 주의사항

1. **레이어 분리는 뷰포트 내부 측정 모드에서만 작동**
2. **페이퍼스페이스 레이어는 항상 표시 상태 유지**
3. **ESC 키나 오류 발생 시 자동으로 레이어 상태 복원**
4. **첫 실행 시에만 레이어 분리 선택 가능**

## 📁 파일 정보
- **파일명**: `SR_with_layer_separation.lsp`
- **기반**: 기존 SR.lsp + SRQ.lsp 레이어 분리 기능
- **호환성**: AutoCAD 2010 이상 버전

## 🧪 테스트 권장사항

1. 뷰포트 내부 모드에서 레이어 분리 기능 테스트
2. 오류 상황(ESC, 예외)에서 레이어 상태 복원 확인
3. 기존 SR 기능들의 정상 작동 확인
4. MVO 뷰포트에서의 정상 작동 확인

이제 기존 SR 리습 대신 `SR_with_layer_separation.lsp`를 사용하시면 레이어 분리 기능이 포함된 측정 도구를 사용할 수 있습니다.