# 🔧 외부참조(XREF) 레이어 분리 문제 해결 방안

## 🚨 문제 상황
- **증상**: 레이어 분리 후 외부참조 객체가 보이지 않음
- **원인**: 외부참조 레이어는 `외부참조명|레이어명` 형식으로 표시되어 기본 레이어명과 다름
- **예시**: `POINT_HEIGHT` 레이어가 외부참조에 있으면 `외부참조파일명|POINT_HEIGHT`로 표시

## ✅ 해결 방안

### 1. 외부참조 레이어 매칭 로직 추가
새로운 함수들을 추가하여 외부참조 레이어를 자동으로 감지하고 처리:

```lisp
;; 외부참조 레이어 이름에서 기본 레이어명 추출
(defun extract-base-layer-name (full_layer_name / pipe_pos)
  (setq pipe_pos (vl-string-search "|" full_layer_name))
  (if pipe_pos
    (substr full_layer_name (+ pipe_pos 2)) ; 파이프 뒤의 레이어명 반환
    full_layer_name ; 외부참조가 아닌 경우 원래 이름 반환
  )
)

;; 외부참조 레이어 매칭 함수
(defun is-layer-match (target_layer current_layer / base_target base_current)
  (setq base_target (extract-base-layer-name target_layer)
        base_current (extract-base-layer-name current_layer))
  (or (= target_layer current_layer)                    ; 완전 일치
      (= base_target base_current)                      ; 기본 레이어명 일치
      (and (vl-string-search "|" current_layer)         ; 현재가 외부참조 레이어이고
           (= base_target base_current))                ; 기본명이 일치
      (and (vl-string-search "|" target_layer)          ; 선택된 것이 외부참조이고
           (= base_target base_current))                ; 기본명이 일치
  )
)
```

### 2. 레이어 분리 함수 개선
기존 레이어 분리 함수를 수정하여 외부참조 레이어를 자동으로 찾아 포함:

```lisp
;; ★★★ 외부참조 레이어 확장 처리 ★★★
;; 모든 도면층을 검사하여 관련 외부참조 레이어 찾기
(setq layers (vla-get-layers acad_doc)
      all_layer_names '())
(vlax-for layer_obj layers
  (setq all_layer_names (cons (vla-get-name layer_obj) all_layer_names)))

;; 선택된 레이어와 매칭되는 모든 레이어 찾기 (외부참조 포함)
(setq xref_layer_names '())
(foreach target_layer target_layer_names
  (foreach all_layer all_layer_names
    (if (is-layer-match target_layer all_layer)
      (if (not (member all_layer xref_layer_names))
        (setq xref_layer_names (cons all_layer xref_layer_names))
      )
    )
  )
)

;; 최종 표시할 레이어 목록 (원래 + 외부참조 매칭)
(setq target_layer_names (remove-duplicates (append target_layer_names xref_layer_names)))
```

## 🎯 작동 원리

### 1. 레이어명 분석
- **내부 레이어**: `POINT_HEIGHT` → 그대로 사용
- **외부참조 레이어**: `도면파일명|POINT_HEIGHT` → `POINT_HEIGHT` 추출

### 2. 매칭 과정
1. 사용자가 객체 선택 (예: `POINT_HEIGHT` 레이어의 객체)
2. 도면의 모든 레이어 검사
3. 기본 레이어명이 `POINT_HEIGHT`인 모든 레이어 찾기:
   - `POINT_HEIGHT` (내부 레이어)
   - `외부참조A|POINT_HEIGHT` (외부참조 A)
   - `외부참조B|POINT_HEIGHT` (외부참조 B)
4. 모든 관련 레이어를 표시 목록에 추가

### 3. 결과
- 내부 레이어와 모든 외부참조의 동일한 레이어가 함께 표시됨
- 사용자는 별도 작업 없이 모든 관련 객체를 볼 수 있음

## 🔄 사용법 (수정된 버전)

### 새로운 파일: `SR_with_xref_layer_support.lsp`

1. **기존과 동일한 방식으로 사용**:
   ```
   Command: SR
   → 뷰포트 내부 모드 선택
   → 뷰포트 선택
   → 레이어 분리: Y
   → 표시할 객체 선택 (외부참조 객체도 포함)
   ```

2. **자동 처리**:
   - 선택된 객체의 레이어명 분석
   - 관련 외부참조 레이어 자동 검색
   - 모든 관련 레이어 동시 표시

3. **결과 확인**:
   ```
   선택된 객체들의 레이어: 'POINT_HEIGHT' '외부참조A|POINT_HEIGHT' 
   외부참조 포함 총 2개 레이어가 표시됩니다.
   >> 레이어 분리 완료: 'POINT_HEIGHT' '외부참조A|POINT_HEIGHT' 만 표시됩니다.
   ```

## ⚡ 성능 및 호환성

### 장점
- **완전 자동**: 사용자 추가 작업 불필요
- **역호환**: 기존 내부 레이어도 정상 작동
- **확장성**: 여러 외부참조 동시 지원

### 특징
- 기존 SR 리습 기능 100% 보존
- 외부참조 처리 로직만 추가
- 오류 상황에서도 안전한 레이어 상태 복원

## 📁 파일 구조

```
/home/user/webapp/
├── SR_with_layer_separation.lsp     # 기본 레이어 분리 버전
├── SR_with_xref_layer_support.lsp   # 외부참조 지원 버전 (최신)
├── SR_레이어분리기능_추가사항.md      # 기본 레이어 분리 설명서
└── 외부참조_레이어분리_해결방안.md    # 외부참조 문제 해결 설명서
```

## 🧪 테스트 권장사항

1. **외부참조가 있는 도면에서 테스트**
2. **동일한 레이어명을 가진 내부/외부참조 객체 동시 선택**
3. **레이어 분리 후 모든 관련 객체가 표시되는지 확인**
4. **작업 완료 후 레이어 상태가 올바르게 복원되는지 확인**

이제 `SR_with_xref_layer_support.lsp`를 사용하시면 외부참조 레이어 문제가 해결되어 `POINT_HEIGHT` 레이어의 모든 객체가 정상적으로 표시될 것입니다! 🎉